<h1>connect-mongo</h1><p>MongoDB session store for <a href="https://github.com/senchalabs/connect">Connect</a> and <a href="http://expressjs.com/">Express</a></p>
<p><a href="https://www.npmjs.com/package/connect-mongo"><img src="https://img.shields.io/npm/v/connect-mongo.svg" alt="npm version"></a>
<a href="https://www.npmjs.com/package/connect-mongo"><img src="https://img.shields.io/npm/dm/connect-mongo.svg" alt="downloads"></a>
<a href="https://travis-ci.org/kcbanner/connect-mongo"><img src="https://travis-ci.org/kcbanner/connect-mongo.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/github/kcbanner/connect-mongo?branch=master"><img src="https://coveralls.io/repos/kcbanner/connect-mongo/badge.svg?branch=master&amp;service=github" alt="Coverage Status"></a>
<a href="https://david-dm.org/kcbanner/connect-mongo"><img src="https://david-dm.org/kcbanner/connect-mongo.svg?style=flat" alt="Dependency Status"></a></p>
<h2>Compatibility</h2><ul>
<li>Support Express up to <code>5.0</code></li>
<li>Support all Connect versions</li>
<li>Support <a href="http://mongoosejs.com/index.html">Mongoose</a> <code>&gt;= 2.6</code>, <code>3.x</code> and <code>4.x</code></li>
<li>Support <a href="http://mongodb.github.io/node-mongodb-native/">native MongoDB driver</a> <code>&gt;= 1.2</code> and <code>2.0</code></li>
<li>Support Node.js <code>0.10</code>, <code>0.12</code>, <code>4.x</code>, <code>5.x</code> and all <a href="https://iojs.org">io.js</a> versions</li>
<li>Support <a href="https://www.mongodb.com/">MongoDB</a> up to <code>3.2</code></li>
</ul>
<p>For older Node.js versions <code>0.10</code>, <code>0.12</code> and io.js, please read the <a href="#old-nodejs-versions-compatibility">Node.js compatibility section</a></p>
<h2>Usage</h2><h3>Express or Connect integration</h3><p>Express <code>4.x</code>, <code>5.0</code> and Connect <code>3.x</code>:</p>
<pre><code class="language-js">const session = require(&#39;express-session&#39;);
const MongoStore = require(&#39;connect-mongo&#39;)(session);

app.use(session({
    secret: &#39;foo&#39;,
    store: new MongoStore(options)
}));
</code></pre>
<p>Express <code>2.x</code>, <code>3.x</code> and Connect <code>1.x</code>, <code>2.x</code>:</p>
<pre><code class="language-js">const MongoStore = require(&#39;connect-mongo&#39;)(express);

app.use(express.session({
    secret: &#39;foo&#39;,
    store: new MongoStore(options)
}));
</code></pre>
<p>For Connect <code>1.x</code> and <code>2.x</code>, just replace <code>express</code> by <code>connect</code>.</p>
<h3>Connection to MongoDB</h3><p>In many circumstances, <code>connect-mongo</code> will not be the only part of your application which need a connection to a MongoDB database. It could be interesting to re-use an existing connection.</p>
<p>Alternatively, you can configure <code>connect-mongo</code> to establish a new connection.</p>
<h4>Re-use a Mongoose connection</h4><pre><code class="language-js">const mongoose = require(&#39;mongoose&#39;);

// Basic usage
mongoose.connect(connectionOptions);

app.use(session({
    store: new MongoStore({ mongooseConnection: mongoose.connection })
}));

// Advanced usage
const connection = mongoose.createConnection(connectionOptions);

app.use(session({
    store: new MongoStore({ mongooseConnection: connection })
}));
</code></pre>
<h4>Re-use a native MongoDB driver connection</h4><p>In this case, you just have to give your <code>Db</code> instance to <code>connect-mongo</code>.
If the connection is not opened, <code>connect-mongo</code> will do it for you.</p>
<pre><code class="language-js">/*
** There are many ways to create dbInstance.
** You should refer to the driver documentation.
*/

app.use(session({
    store: new MongoStore({ db: dbInstance })
}));
</code></pre>
<h4>Create a new connection from a MongoDB connection string</h4><p><a href="http://docs.mongodb.org/manual/reference/connection-string/">MongoDB connection strings</a> are <strong>the best way</strong> to configure a new connection. For advanced usage, <a href="http://mongodb.github.io/node-mongodb-native/driver-articles/mongoclient.html#mongoclient-connect-options">more options</a> can be configured with <code>mongoOptions</code> property.</p>
<pre><code class="language-js">// Basic usage
app.use(session({
    store: new MongoStore({ url: &#39;mongodb://localhost/test-app&#39; })
}));

// Advanced usage
app.use(session({
    store: new MongoStore({
        url: &#39;mongodb://user12345:foobar@localhost/test-app?authSource=admins&amp;w=1&#39;,
        mongoOptions: advancedOptions // See below for details
    })
}));
</code></pre>
<h2>Old Node.js versions compatibility</h2><p>For versions <code>0.10</code>, <code>0.12</code> and io.js, you must use the ES5 fallback:</p>
<pre><code class="language-js">var MongoStore = require(&#39;connect-mongo/es5&#39;)(session);
</code></pre>
<h2>Session expiration</h2><p>When the session cookie has an expiration date, <code>connect-mongo</code> will use it.</p>
<p>Otherwise, it will create a new one, using <code>ttl</code> option.</p>
<pre><code class="language-js">app.use(session({
    store: new MongoStore({
      url: &#39;mongodb://localhost/test-app&#39;,
      ttl: 14 * 24 * 60 * 60 // = 14 days. Default
    })
}));
</code></pre>
<p><strong>Note:</strong> Each time an user interacts with the server, its session expiration date is refreshed.</p>
<h2>Remove expired sessions</h2><p>By default, <code>connect-mongo</code> uses MongoDB&#39;s TTL collection feature (2.2+) to have mongod automatically remove expired sessions. But you can change this behavior.</p>
<h3>Set MongoDB to clean expired sessions (default mode)</h3><p><code>connect-mongo</code> will create a TTL index for you at startup. You MUST have MongoDB 2.2+ and administration permissions.</p>
<pre><code class="language-js">app.use(session({
    store: new MongoStore({
      url: &#39;mongodb://localhost/test-app&#39;,
      autoRemove: &#39;native&#39; // Default
    })
}));
</code></pre>
<p><strong>Note:</strong> If you use <code>connect-mongo</code> in a very concurrent environment, you should avoid this mode and prefer setting the index yourself, once!</p>
<h3>Set the compatibility mode</h3><p>You have an older MongoDB version (compatible with connect-mongo) or you can&#39;t or don&#39;t want to create a TTL index.</p>
<p><code>connect-mongo</code> will take care of removing expired sessions, using defined interval.</p>
<pre><code class="language-js">app.use(session({
    store: new MongoStore({
      url: &#39;mongodb://localhost/test-app&#39;,
      autoRemove: &#39;interval&#39;,
      autoRemoveInterval: 10 // In minutes. Default
    })
}));
</code></pre>
<h3>Disable expired sessions cleaning</h3><p>You are in production environnement and/or you manage the TTL index elsewhere.</p>
<pre><code class="language-js">app.use(session({
    store: new MongoStore({
      url: &#39;mongodb://localhost/test-app&#39;,
      autoRemove: &#39;disabled&#39;
    })
}));
</code></pre>
<h2>Lazy session update</h2><p>If you are using <a href="https://github.com/expressjs/session">express-session</a> &gt;= <a href="https://github.com/expressjs/session/releases/tag/v1.10.0">1.10.0</a> and don&#39;t want to resave all the session on database every single time that the user refresh the page, you can lazy update the session, by limiting a period of time.</p>
<pre><code class="language-js">app.use(express.session({
    secret: &#39;keyboard cat&#39;,
    saveUninitialized: false, // don&#39;t create session until something stored
    resave: false, //don&#39;t save session if unmodified
    store: new mongoStore({
        url: &#39;mongodb://localhost/test-app&#39;,
        touchAfter: 24 * 3600 // time period in seconds
    })
}));
</code></pre>
<p>by doing this, setting <code>touchAfter: 24 * 3600</code> you are saying to the session be updated only one time in a period of 24 hours, does not matter how many request&#39;s are made (with the exception of those that change something on the session data)</p>
<h2>More options</h2><ul>
<li><code>collection</code> Collection (default: <code>sessions</code>)</li>
<li><code>fallbackMemory</code> Fallback to <code>MemoryStore</code>. Useful if you want to use MemoryStore in some case, like in development environment.</li>
<li><code>stringify</code> If true, connect-mongo will serialize sessions using <code>JSON.stringify</code> before<pre><code>        setting them, and deserialize them with `JSON.parse` when getting them.
        (optional, default: true). This is useful if you are using types that
        MongoDB doesn&#39;t support.
</code></pre></li>
<li><code>serialize</code> Custom hook for serializing sessions to MongoDB. This is helpful if you need<pre><code>        to modify the session before writing it out.
</code></pre></li>
<li><code>unserialize</code> Custom hook for unserializing sessions from MongoDB. This can be used in<pre><code>        scenarios where you need to support different types of serializations
        (e.g., objects and JSON strings) or need to modify the session before using
        it in your app.
</code></pre></li>
<li><code>transformId</code> (optional) Transform original sessionId in whatever you want to use as storage key.</li>
</ul>
<h2>Tests</h2><pre><code>npm test
</code></pre><p>The tests use a database called <code>connect-mongo-test</code>.</p>
<h2>License</h2><p>The MIT License</p>
